# LottoPro-AI 로그 로테이션 설정
# /etc/logrotate.d/lottopro-ai 에 복사하여 사용

# 메인 애플리케이션 로그
/opt/lottopro-ai/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 lottopro lottopro
    
    postrotate
        # 로그 로테이션 후 애플리케이션에 HUP 시그널 전송
        if [ -f /var/run/lottopro-ai.pid ]; then
            kill -HUP `cat /var/run/lottopro-ai.pid`
        fi
        
        # systemctl을 통한 재로드 (대안)
        # systemctl reload lottopro-ai || true
    endscript
}

# 성능 모니터링 로그 (더 자주 로테이션)
/opt/lottopro-ai/logs/performance/*.log {
    hourly
    missingok
    rotate 168  # 1주일 (24시간 * 7일)
    compress
    delaycompress
    notifempty
    create 644 lottopro lottopro
    maxsize 100M
    
    postrotate
        # JSON 형태의 로그이므로 특별한 처리 불필요
        echo "Performance logs rotated at $(date)" >> /opt/lottopro-ai/logs/rotation.log
    endscript
}

# 캐시 관련 로그
/opt/lottopro-ai/logs/cache/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 644 lottopro lottopro
    maxsize 50M
    
    postrotate
        # 캐시 통계 정리 스크립트 실행 (있다면)
        /opt/lottopro-ai/scripts/cache_cleanup.sh || true
    endscript
}

# 에러 로그 (더 오래 보관)
/opt/lottopro-ai/logs/error/*.log {
    daily
    missingok
    rotate 90
    compress
    delaycompress
    notifempty
    create 644 lottopro lottopro
    
    postrotate
        # 에러 로그는 알림 시스템에 통지
        /opt/lottopro-ai/scripts/error_alert.sh "$1" || true
    endscript
}

# 액세스 로그
/opt/lottopro-ai/logs/access/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 644 lottopro lottopro
    sharedscripts
    
    postrotate
        # 액세스 로그 통계 생성 (선택사항)
        /opt/lottopro-ai/scripts/generate_access_stats.sh || true
    endscript
}

# 백업 로그
/opt/lottopro-ai/logs/backup/*.log {
    weekly
    missingok
    rotate 12
    compress
    delaycompress
    notifempty
    create 644 lottopro lottopro
}

# Nginx 로그 (시스템 전체 설정)
/var/log/nginx/lottopro-*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    sharedscripts
    
    postrotate
        # Nginx 재로드
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 `cat /var/run/nginx.pid`
        fi
    endscript
}

# Redis 로그
/var/log/redis/redis-server.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 640 redis redis
    
    postrotate
        # Redis는 로그 파일을 자동으로 다시 열지 않으므로 재시작 필요
        systemctl reload redis-server || true
    endscript
}

# 시스템 로그 (LottoPro-AI 관련만)
/var/log/syslog {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    sharedscripts
    
    prerotate
        # LottoPro-AI 관련 로그만 별도 백업
        grep "lottopro-ai" /var/log/syslog > /opt/lottopro-ai/logs/system/lottopro-system.log.$(date +%Y%m%d) || true
    endscript
    
    postrotate
        # rsyslog 재시작
        systemctl reload rsyslog || true
    endscript
}

# 저장공간 정리 스크립트
# /opt/lottopro-ai/scripts/cleanup_old_logs.sh
/opt/lottopro-ai/archives/*.log.gz {
    monthly
    missingok
    rotate 6
    nocompress  # 이미 압축됨
    notifempty
    
    postrotate
        # 6개월 이상된 아카이브 파일 삭제
        find /opt/lottopro-ai/archives -name "*.log.gz" -mtime +180 -delete
        
        # 저장공간 사용량 체크
        df -h /opt/lottopro-ai | awk 'NR==2 {print $5 " used"}' >> /opt/lottopro-ai/logs/disk_usage.log
    endscript
}

# 설치 및 테스트 방법:
# 1. sudo cp config/logrotate.conf /etc/logrotate.d/lottopro-ai
# 2. sudo logrotate -d /etc/logrotate.d/lottopro-ai  # 테스트 (실제 실행 안함)
# 3. sudo logrotate -f /etc/logrotate.d/lottopro-ai  # 강제 실행 (테스트용)
# 4. sudo logrotate -v /etc/logrotate.d/lottopro-ai  # 상세 로그와 함께 실행

# 로그로테이션 상태 확인:
# cat /var/lib/logrotate/status | grep lottopro

# 주의사항:
# - 로그 파일 경로는 실제 설치 경로에 맞춰 수정 필요
# - 사용자/그룹 권한 확인 필요 (lottopro:lottopro)
# - postrotate 스크립트들이 실행 가능한지 확인
# - 디스크 공간이 충분한지 정기 확인 필요

# 성능 고려사항:
# - 너무 자주 로테이션하면 I/O 부하 증가
# - compress 옵션으로 저장공간 절약
# - delaycompress로 현재 로그 파일은 압축하지 않음
# - maxsize로 로그 파일이 너무 커지는 것 방지

# 보안 고려사항:
# - 로그 파일 권한 적절히 설정 (644)
# - 민감한 정보가 로그에 기록되지 않도록 주의
# - 로그 파일 백업 시 암호화 고려
