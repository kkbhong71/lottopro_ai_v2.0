<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LottoPro-AI 모니터링 대시보드</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-healthy {
            background: #27ae60;
            color: white;
        }
        
        .status-warning {
            background: #f39c12;
            color: white;
        }
        
        .status-critical {
            background: #e74c3c;
            color: white;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .metric-title {
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #27ae60;
            margin-bottom: 5px;
        }
        
        .metric-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
            margin-bottom: 15px;
        }
        
        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }
        
        .info-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .info-value {
            color: #34495e;
        }
        
        .alert-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .alert-warning {
            background: rgba(243, 156, 18, 0.1);
            border-left-color: #f39c12;
        }
        
        .alert-critical {
            background: rgba(231, 76, 60, 0.1);
            border-left-color: #e74c3c;
        }
        
        .refresh-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #3498db;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .table-responsive {
            overflow-x: auto;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .table th {
            background: rgba(0,0,0,0.05);
            font-weight: 600;
            color: #2c3e50;
        }
        
        .endpoint-stats {
            font-size: 0.9em;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .progress-cpu { background: #e74c3c; }
        .progress-memory { background: #f39c12; }
        .progress-disk { background: #9b59b6; }
        
        @media (max-width: 768px) {
            .dashboard {
                padding: 10px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .refresh-controls {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>
                <i class="fas fa-chart-line"></i>
                LottoPro-AI 모니터링 대시보드
                <div class="status-badge" id="systemStatus">Loading...</div>
            </h1>
            <div class="refresh-controls">
                <button class="btn btn-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i>
                    새로고침
                </button>
                <button class="btn btn-success" onclick="clearCache()">
                    <i class="fas fa-broom"></i>
                    캐시 정리
                </button>
                <button class="btn btn-warning" onclick="exportMetrics()">
                    <i class="fas fa-download"></i>
                    메트릭 내보내기
                </button>
                <div class="auto-refresh">
                    <span>자동 새로고침</span>
                    <label class="switch">
                        <input type="checkbox" id="autoRefresh" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <span id="lastUpdate">마지막 업데이트: -</span>
            </div>
        </div>
        
        <div class="metrics-grid" id="metricsGrid">
            <!-- 동적으로 생성됩니다 -->
        </div>
        
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-tachometer-alt"></i>
                시스템 성능 추이
            </div>
            <div class="chart-wrapper">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-server"></i>
                API 엔드포인트 통계
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>엔드포인트</th>
                            <th>요청 수</th>
                            <th>평균 응답시간</th>
                            <th>에러 수</th>
                            <th>에러율</th>
                        </tr>
                    </thead>
                    <tbody id="endpointStats">
                        <!-- 동적으로 생성됩니다 -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="alert-section" id="alertSection" style="display: none;">
            <div class="chart-title">
                <i class="fas fa-exclamation-triangle"></i>
                시스템 알림
            </div>
            <div id="alertList">
                <!-- 동적으로 생성됩니다 -->
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-info-circle"></i>
                시스템 정보
            </div>
            <div class="system-info" id="systemInfo">
                <!-- 동적으로 생성됩니다 -->
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        let performanceChart = null;
        let autoRefreshInterval = null;
        let isRefreshing = false;
        
        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            refreshData();
            setupAutoRefresh();
        });
        
        // 자동 새로고침 설정
        function setupAutoRefresh() {
            const autoRefreshCheckbox = document.getElementById('autoRefresh');
            
            autoRefreshCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    autoRefreshInterval = setInterval(refreshData, 30000); // 30초마다
                } else {
                    clearInterval(autoRefreshInterval);
                }
            });
            
            // 기본적으로 자동 새로고침 활성화
            autoRefreshInterval = setInterval(refreshData, 30000);
        }
        
        // 차트 초기화
        function initializeCharts() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU (%)',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Memory (%)',
                        data: [],
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        tension: 0.4
                    }, {
                        label: '응답시간 (ms)',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: '사용률 (%)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '응답시간 (ms)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        // 데이터 새로고침
        async function refreshData() {
            if (isRefreshing) return;
            isRefreshing = true;
            
            try {
                // 성능 통계 가져오기
                const performanceResponse = await fetch('/admin/performance');
                const performanceData = await performanceResponse.json();
                
                if (performanceData.success) {
                    updateMetrics(performanceData.data);
                    updateSystemStatus(performanceData.data);
                    updateEndpointStats(performanceData.data.endpoints);
                    updateSystemInfo(performanceData.data);
                    updateChart(performanceData.data);
                }
                
                // 캐시 정보 가져오기
                const cacheResponse = await fetch('/admin/cache/info');
                const cacheData = await cacheResponse.json();
                
                if (cacheData.success) {
                    updateCacheMetrics(cacheData.data);
                }
                
                document.getElementById('lastUpdate').textContent = 
                    `마지막 업데이트: ${new Date().toLocaleString()}`;
                    
            } catch (error) {
                console.error('데이터 새로고침 실패:', error);
                showAlert('데이터 새로고침에 실패했습니다.', 'critical');
            }
            
            isRefreshing = false;
        }
        
        // 메트릭 업데이트
        function updateMetrics(data) {
            const metricsGrid = document.getElementById('metricsGrid');
            const overview = data.overview;
            const system = data.system;
            
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">
                            <i class="fas fa-globe"></i>
                            총 요청 수
                        </div>
                    </div>
                    <div class="metric-value">${overview.total_requests.toLocaleString()}</div>
                    <div class="metric-label">전체 API 요청</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            에러율
                        </div>
                    </div>
                    <div class="metric-value" style="color: ${overview.error_rate > 5 ? '#e74c3c' : '#27ae60'}">${overview.error_rate}%</div>
                    <div class="metric-label">${overview.total_errors}개 에러</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">
                            <i class="fas fa-clock"></i>
                            평균 응답시간
                        </div>
                    </div>
                    <div class="metric-value" style="color: ${overview.average_response_time > 5 ? '#f39c12' : '#27ae60'}">${overview.average_response_time.toFixed(3)}s</div>
                    <div class="metric-label">평균 처리 시간</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">
                            <i class="fas fa-microchip"></i>
                            CPU 사용률
                        </div>
                    </div>
                    <div class="metric-value" style="color: ${system.current_cpu > 80 ? '#e74c3c' : '#27ae60'}">${system.current_cpu}%</div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-cpu" style="width: ${system.current_cpu}%"></div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">
                            <i class="fas fa-memory"></i>
                            메모리 사용률
                        </div>
                    </div>
                    <div class="metric-value" style="color: ${system.current_memory > 85 ? '#e74c3c' : '#27ae60'}">${system.current_memory}%</div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-memory" style="width: ${system.current_memory}%"></div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">
                            <i class="fas fa-hdd"></i>
                            디스크 사용률
                        </div>
                    </div>
                    <div class="metric-value" style="color: ${system.current_disk > 90 ? '#e74c3c' : '#27ae60'}">${system.current_disk}%</div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-disk" style="width: ${system.current_disk}%"></div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">
                            <i class="fas fa-arrow-up"></i>
                            서버 가동시간
                        </div>
                    </div>
                    <div class="metric-value">${overview.uptime_human}</div>
                    <div class="metric-label">연속 가동</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">
                            <i class="fas fa-heartbeat"></i>
                            시스템 상태
                        </div>
                    </div>
                    <div class="metric-value" style="color: ${getHealthColor(data.health_status)}">${getHealthLabel(data.health_status)}</div>
                    <div class="metric-label">전반적 건강도</div>
                </div>
            `;
        }
        
        // 캐시 메트릭 추가
        function updateCacheMetrics(cacheData) {
            const metricsGrid = document.getElementById('metricsGrid');
            const stats = cacheData.stats;
            
            const cacheCard = `
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">
                            <i class="fas fa-database"></i>
                            캐시 히트율
                        </div>
                    </div>
                    <div class="metric-value" style="color: ${stats.hit_rate > 80 ? '#27ae60' : stats.hit_rate > 60 ? '#f39c12' : '#e74c3c'}">${stats.hit_rate.toFixed(1)}%</div>
                    <div class="metric-label">${stats.total_operations}회 연산</div>
                </div>
            `;
            
            metricsGrid.insertAdjacentHTML('beforeend', cacheCard);
        }
        
        // 시스템 상태 업데이트
        function updateSystemStatus(data) {
            const statusElement = document.getElementById('systemStatus');
            const health = data.health_status;
            
            statusElement.className = `status-badge status-${health}`;
            statusElement.textContent = getHealthLabel(health);
        }
        
        // 엔드포인트 통계 업데이트
        function updateEndpointStats(endpoints) {
            const tbody = document.getElementById('endpointStats');
            tbody.innerHTML = '';
            
            Object.entries(endpoints).forEach(([endpoint, stats]) => {
                const errorRate = ((stats.errors / stats.count) * 100).toFixed(1);
                const row = tbody.insertRow();
                
                row.innerHTML = `
                    <td><code>${endpoint}</code></td>
                    <td>${stats.count.toLocaleString()}</td>
                    <td>${stats.avg_time.toFixed(3)}s</td>
                    <td>${stats.errors}</td>
                    <td style="color: ${errorRate > 5 ? '#e74c3c' : '#27ae60'}">${errorRate}%</td>
                `;
            });
        }
        
        // 시스템 정보 업데이트
        function updateSystemInfo(data) {
            const systemInfo = document.getElementById('systemInfo');
            const overview = data.overview;
            
            systemInfo.innerHTML = `
                <div class="info-item">
                    <div class="info-label">모니터링 활성화</div>
                    <div class="info-value">${data.monitoring_active ? '활성' : '비활성'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">수집 간격</div>
                    <div class="info-value">${data.collection_interval}초</div>
                </div>
                <div class="info-item">
                    <div class="info-label">응답시간 임계값</div>
                    <div class="info-value">${data.thresholds.response_time}초</div>
                </div>
                <div class="info-item">
                    <div class="info-label">CPU 임계값</div>
                    <div class="info-value">${data.thresholds.cpu_usage}%</div>
                </div>
                <div class="info-item">
                    <div class="info-label">메모리 임계값</div>
                    <div class="info-value">${data.thresholds.memory_usage}%</div>
                </div>
                <div class="info-item">
                    <div class="info-label">디스크 임계값</div>
                    <div class="info-value">${data.thresholds.disk_usage}%</div>
                </div>
            `;
        }
        
        // 차트 업데이트
        function updateChart(data) {
            const system = data.system;
            const overview = data.overview;
            
            // 현재 시간을 라벨로 추가
            const currentTime = new Date().toLocaleTimeString();
            performanceChart.data.labels.push(currentTime);
            
            // 데이터 포인트 추가
            performanceChart.data.datasets[0].data.push(system.current_cpu);
            performanceChart.data.datasets[1].data.push(system.current_memory);
            performanceChart.data.datasets[2].data.push(overview.average_response_time * 1000); // ms로 변환
            
            // 최대 20개 데이터 포인트만 유지
            const maxPoints = 20;
            if (performanceChart.data.labels.length > maxPoints) {
                performanceChart.data.labels.shift();
                performanceChart.data.datasets.forEach(dataset => {
                    dataset.data.shift();
                });
            }
            
            performanceChart.update();
        }
        
        // 유틸리티 함수들
        function getHealthColor(health) {
            switch(health) {
                case 'healthy': return '#27ae60';
                case 'warning': return '#f39c12';
                case 'critical': return '#e74c3c';
                default: return '#7f8c8d';
            }
        }
        
        function getHealthLabel(health) {
            switch(health) {
                case 'healthy': return '정상';
                case 'warning': return '주의';
                case 'critical': return '위험';
                default: return '알 수 없음';
            }
        }
        
        function showAlert(message, type = 'warning') {
            const alertSection = document.getElementById('alertSection');
            const alertList = document.getElementById('alertList');
            
            const alertItem = document.createElement('div');
            alertItem.className = `alert-item alert-${type}`;
            alertItem.innerHTML = `
                <i class="fas fa-${type === 'critical' ? 'exclamation-triangle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            alertList.appendChild(alertItem);
            alertSection.style.display = 'block';
            
            // 5초 후 자동 제거
            setTimeout(() => {
                alertItem.remove();
                if (alertList.children.length === 0) {
                    alertSection.style.display = 'none';
                }
            }, 5000);
        }
        
        // 캐시 정리
        async function clearCache() {
            try {
                const response = await fetch('/admin/cache/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ pattern: '*' })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`캐시 정리 완료: ${result.cleared_count}개 항목 삭제`, 'info');
                    refreshData();
                } else {
                    showAlert('캐시 정리에 실패했습니다.', 'critical');
                }
            } catch (error) {
                showAlert('캐시 정리 중 오류가 발생했습니다.', 'critical');
            }
        }
        
        // 메트릭 내보내기
        async function exportMetrics() {
            try {
                window.open('/admin/performance/export?format=json', '_blank');
            } catch (error) {
                showAlert('메트릭 내보내기에 실패했습니다.', 'critical');
            }
        }
    </script>
</body>
</html>
